<!DOCTYPE html>
<html lang="en-us">

<head>
<meta charset="utf-8">
<title>Heroclix Map Viewer</title>
<style type="text/css">
#mapTitle {
	font-family: Arial, Helvetica, sans-serif;
	font-size: xx-large;
	font-weight: bold;
	background-color: #E3F0FB;
	text-align: center;
}
.mapInfo {
	font-family: Arial, Helvetica, sans-serif;
	font-size: medium;
	font-weight: bold;
	background-color: #E3F0FB;
	text-align: center;
}
.top {
  position:fixed;
  left:0; right:0;
  height: 80px;
	background-color: #E3F0FB;
}
.topLeft {
  position:fixed;
  left:0; right:0;
  width: 178px;
}
.topRight {
  position:fixed;
  right:0;
  width: 178px;
  text-align: right;
}
#tableOfContents {
  position: fixed;
  left:0; top:92px; bottom: 150;
  width: 178px;
  height: calc(100% - 92px);
  overflow: scroll;
}
.main {
  position: absolute;
  left:178px; top:92px; right:0; bottom:0;
}
</style>
</head>

<body>
<div class="main">
  <canvas id="mapCanvas"></canvas>
</div>
<div class="top">
  <div id="mapTitle">
    <span id="mapName"></span>
    <div id="mapSet" class="mapInfo"></div>
    <div id="mapType" class="mapInfo"></div>
  </div>
</div>
<div id="tableOfContents"></div>
<div class="topLeft">
  <button onclick="previousMap()">Previous</button>
  <br>
  <div>Age:
    <select id="selectAge" onchange="drawTableOfContents()">
      <option value="modern">Modern</option>
      <option value="wko">WizKids Events</option>
      <option value="all">Golden</option>
    </select>
  </div>
  <div>Type:
    <select id="selectType" onchange="drawTableOfContents()">
      <option value="all">All</option>
      <option value="indoor">Indoor</option>
      <option value="outdoor">Outdoor</option>
      <option value="indoorOutdoor">Indoor/Outdoor</option>
    </select>
  </div>
  <div>Size:
    <select id="selectSize" onchange="drawTableOfContents()">
      <option value="16x24">16x24</option>
      <option value="all">All</option>
    </select>
  </div>
</div>
<div class="topRight">
  <button onclick="nextMap()">Next</button>
  <br><br>
  <div>Zoom:
    <select id="selectZoom" onchange="drawMap()">
      <option value="0">Fit</option>
      <option value="0.5">50%</option>
      <option value="0.75">75%</option>
      <option value="1.0">100%</option>
    </select>
  </div>
</div>


<script type="text/javascript" src="js/edge.js"></script>
<script type="text/javascript" src="js/tile.js"></script>
<script type="text/javascript" src="js/wall.js"></script>
<script type="text/javascript" src="js/character.js"></script>
<script type="text/javascript" src="js/map.js"></script>

<script>

function getJson(location, callback) {
	var request = new XMLHttpRequest();
	request.overrideMimeType("application/json");
    request.open('GET', location, true);
    request.onreadystatechange = function () {
    	if (request.readyState == 4 && request.status == "200") {
    		callback(request.responseText);
    	}
    };
    request.send(null);  
}

var map;
var mapIndex;
var mapTableOfContents;
var scale;
var translationX;

function loadMap() {
  getJson(mapTableOfContents[mapIndex].file, function(json) {
		var jsonMap;
		try {
			jsonMap = JSON.parse(json);
		} catch (e) {
			alert(e);
		}
    map = new Map(jsonMap);
    drawMap();
  });
}

function drawMap() {
  var c = document.getElementById("mapCanvas");
  var left = document.getElementById("left");
  var ctx = c.getContext("2d");
  ctx.save()
  var windowWidth = window.innerWidth - 178;
  var windowHeight = window.innerHeight - 100;
  var mapScale = document.getElementById("selectZoom").value;
  if (mapScale <= 0) {
    c.width = windowWidth;
    c.height = windowHeight;
    var sx = c.width / (map.width * TILE_SIZE);
    var sy = c.height / (map.height * TILE_SIZE);
    scale = sx < sy ? sx : sy;
    translationX = (c.width / scale - map.width * TILE_SIZE) / 2;
    ctx.scale(scale, scale);
    ctx.translate(translationX, 0);
  } else if (mapScale >= 1) {
    c.width = map.width * TILE_SIZE;
    c.height = map.height * TILE_SIZE;
    scale = 1;
    translationX = 0;
  } else {
    c.width = Math.max(windowWidth, map.width * TILE_SIZE * mapScale);
    c.height = map.height * TILE_SIZE * mapScale;
    scale = mapScale;
    translationX = (c.width / scale - map.width * TILE_SIZE) / 2;
    ctx.scale(scale, scale);
    ctx.translate(translationX, 0);
  }
  map.draw(ctx);
  ctx.restore();
  document.getElementById("mapName").innerHTML = map.name;
  document.getElementById("mapSet").innerHTML = map.set;
  var mapType;
  if (map.type == "indoor") {
    mapType = "Indoor";
  } else if (map.type == "outdoor") {
    mapType = "Outdoor";
  } else if (map.type == "indoorOutdoor") {
    mapType = "Indoor/Outdoor";
  }
  document.getElementById("mapType").innerHTML = mapType;
}

var jsontableOfContents;
function loadTableOfContents() {
  getJson("maps/table_of_contents.json", function(data) {
		try {
			jsontableOfContents = JSON.parse(data);
		} catch (e) {
			alert(e);
		}
		drawTableOfContents();
  });
}

function drawTableOfContents() {
	var filterByAge = document.getElementById("selectAge").value;
	var filterByType = document.getElementById("selectType").value;
	var filter16x24 = (document.getElementById("selectSize").value == "16x24");
	var html = "";
	var currentSet = "";
	mapTableOfContents = [];
	for (var i = 0; i < jsontableOfContents.maps.length; ++i) {
	  var map = jsontableOfContents.maps[i];
	  if (filterByAge != "all" && !(map.age && map.age[filterByAge])) {
	    continue;
	  }
	  if (filterByType != "all" && filterByType != map.type) {
	    continue
	  }
	  if (filter16x24 && !(map.width == 16 && map.height == 24)) {
	    continue;
	  }
	  if (currentSet != map.set) {
	    if (currentSet != "") {
	      html += "</ul>"
	    }
	    html += map.set + " <ul>"
	    currentSet = map.set;
	  }
	  html += "<li>"
	      + "<a href='' onclick='mapIndex="
	      + mapTableOfContents.length + "; loadMap(); return false;'>"
	      + map.name + "</a></li>";
	  mapTableOfContents.push(map);
	}
	html += "</ul>"
  var tableOfContents = document.getElementById("tableOfContents");
  tableOfContents.innerHTML = html;
  mapIndex = 0;
  loadMap();
}

loadTableOfContents();

document.onkeydown = handleKeyDown;

function handleKeyDown(e) {
	var KEY_LEFT = '37';
	var KEY_RIGHT = '39';
  e = e || window.event;
  if (e.keyCode == KEY_LEFT) {
    previousMap();
  } else if (e.keyCode == KEY_RIGHT) {
    nextMap();
  }
}

function previousMap() {
  --mapIndex;
  if (mapIndex < 0) {
    mapIndex = mapTableOfContents.length - 1;
  }
	loadMap();
}

function nextMap() {
  ++mapIndex;
  if (mapIndex >= mapTableOfContents.length) {
    mapIndex = 0;
  }
	loadMap();
}

var canvas = document.getElementById("mapCanvas");
canvas.addEventListener("mousedown", onMouseDown, false);

function onMouseDown(event) {
  var canvas = document.getElementById("mapCanvas");
  var rect = canvas.getBoundingClientRect();
  var x = event.clientX - rect.left;
  var y = event.clientY - rect.top;
  x -= canvas.offsetLeft;
  y -= canvas.offsetTop;
  x /= scale;
  y /= scale;
  x -= translationX;
  x = Math.floor(x / TILE_SIZE);
  y = Math.floor(y / TILE_SIZE);
  map.toggleCharacter(x, y);
  drawMap();
}

</script>

</body>
</html>
